<html>
<head>

<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
<script src="https://www.puck-js.com/puck.js"></script>
<script src="https://bernii.github.io/gauge.js/dist/gauge.min.js"></script>

<style>
#log { overflow-x:scroll; overflow-y:scroll;
    font-size:50%;font-family:"monospace";
    white-space: nowrap;
    position:absolute;
    top:0px;
    z-index:-20;
    height: 100vh;
    width:50vh;
 }

.gauge {
  position:absolute;
  right : 0vh;
  width : 50vh;
  height : 50vh;
  z-index : -10;
}
.gauge span {
  font-size: 5vh;
}
.gauge canvas {
  width : 50vh;
  height : 40vh;
}
#speeddiv {
  top: 0vh;
}
#wattsdiv {
  top: 50vh;
}
</style>
</head>
<body>
<div class="gauge" id="speeddiv">
  <span id="speed-textfield"></span><span>kph</span>
  <canvas id="speed"></canvas>
</div>
<div class="gauge" id="wattsdiv">
  <span id="watts-textfield"></span><span>W</span>
  <canvas id="watts"></canvas>
</div>

<header class="navbar">
  <section class="navbar-section">
    <a class="navbar-brand mr-2">Greenpower Telemetry</a>
  </section>
  <section class="navbar-section">
    <button class="btn btn-default" id="urlBtn">Set URL</button>
    <button class="btn btn-primary" id="connectBtn">Connect</button>
  </section>
</header>

<div id="log">




</div>


<script>

const CODE = `
Modules.addCached("DS18B20x",function(){function e(a,b){this.bus=a;void 0===b?this.sCode=this.bus.search()[0]:parseInt(b).toString()==b&&0<=b&&126>=b?this.sCode=this.bus.search()[b]:this.sCode=b;if(!this.sCode)throw Error("No DS18B20 found");this.type=parseInt(this.sCode[0]+this.sCode[1])}e.prototype._r=function(){var a=this.bus;a.select(this.sCode);a.write(190);return a.read(9)};e.prototype._w=function(a,b,f){var c=this.bus;c.select(this.sCode);c.write([78,a,b,f]);c.select(this.sCode);c.write(72);c.reset()};e.prototype.setRes=
function(a){var b=this._r();a=[31,63,95,127][E.clip(a,9,12)-9];this._w(b[2],b[3],a)};e.prototype.getRes=function(){return[31,63,95,127].indexOf(this._r()[4])+9};e.prototype.isPresent=function(){return-1!==this.bus.search().indexOf(this.sCode)};e.prototype.getTemp=function(a){function b(f){for(var c=f._r(),g=0,d=0;8>d;d++){g^=c[d];for(var h=0;8>h;h++)g=g>>1^140*(g&1)}d=null;g==c[8]&&(d=c[0]+(c[1]<<8),d&32768&&(d-=65536),d/=10==f.type?2:16);a&&a(d);return d}this.bus.select(this.sCode);this.bus.write(68,
!0);if(!a)return b(this);setTimeout(b,{9:94,10:188,11:375,12:750}[this.getRes()],this)};e.prototype.searchAlarm=function(){return this.bus.search(236)};e.prototype.setAlarm=function(a,b){a--;0>a&&(a+=256);0>b&&(b+=256);var f=this._r();this._w(b,a,f[4])};exports.connect=function(a,b){return new e(a,b)}});
var saadc=function(a){var b={status:1073771520,enable:1073771776,amount:1073772084,tStart:1073770496,tSample:1073770500,tStop:1073770504,tCalib:1073770508,
eResultDone:1073770764,eEnd:1073770756,setDMA:function(c){c=c||{};poke32(1073772076,0|c.ptr);poke32(1073772080,0|c.cnt)},sample:function(c){c=c||1;if(1<c&&!a.samplerate)throw"Can't do >1 sample with no samplerate specified";if(1<c&&1<a.channels.length)throw"Can't do >1 channel with a samplerate specified";var f=new Uint16Array(Math.max(c*a.channels.length,32)),g=E.getAddressOf(f,!0);b.setDMA({ptr:g,cnt:c*a.channels.length});poke32(b.eEnd,0);poke32(b.tStart,1);for(poke32(b.tSample,1);!peek32(b.eEnd););
poke32(b.tStop,1);b.setDMA();return f.slice(0,c*a.channels.length)}},d=[void 0,"down","up","vcc/2"],e=[1/6,.2,.25,1/3,.5,1,2,4],k=[3,5,10,15,20,40];a.resolution||(a.resolution=14);if(!a.channels||8<a.channels.length)throw"Invalid channels";if(a.oversample&&1<a.channels.length)throw"Can't oversample with >1 channel";if(a.samplerate&&1<a.channels.length)throw"Can't use samplerate with >1 channel";poke32(b.enable,0);for(var h=0;8>h;h++)poke32(1073771792+16*h,0);a.channels.forEach(function(c,f){f=1073771792+
16*f;c.gain||(c.gain=1);c.tacq||(c.tacq=3);if(0>d.indexOf(c.pinpull))throw"Invalid pinpull";if(0>d.indexOf(c.npinpull))throw"Invalid npinpull";if(0>e.indexOf(c.gain))throw"Invalid gain";if(0>k.indexOf(c.tacq))throw"Invalid tacq";var g=d.indexOf(c.pinpull)|d.indexOf(c.npinpull)<<4|e.indexOf(c.gain)<<8|!!c.refvdd<<12|k.indexOf(c.tacq)<<16|(void 0!==c.npin)<<20|!!a.oversample<<24;poke32(f+8,g);poke32(f,0|(new Pin(c.pin)).getInfo().channel+1);poke32(f+4,0|(c.npin&&(new Pin(c.npin)).getInfo().channel)+
1)});poke32(1073772016,a.resolution-8>>1);poke32(1073772020,0|a.oversample);poke32(1073772024,a.samplerate|!!a.samplerate<<12);b.setDMA(a.dma);poke32(b.enable,1);return b};

var data;
var currentSense;

function rnd(v) { return Math.round(v*100)/100 }

Modules.addCached("DS18B20x",function(){function e(a,b){this.bus=a;void 0===b?this.sCode=this.bus.search()[0]:parseInt(b).toString()==b&&0<=b&&126>=b?this.sCode=this.bus.search()[b]:this.sCode=b;if(!this.sCode)throw Error("No DS18B20 found");this.type=parseInt(this.sCode[0]+this.sCode[1])}e.prototype._r=function(){var a=this.bus;a.select(this.sCode);a.write(190);return a.read(9)};e.prototype._w=function(a,b,f){var c=this.bus;c.select(this.sCode);c.write([78,a,b,f]);c.select(this.sCode);c.write(72);c.reset()};e.prototype.setRes=
function(a){var b=this._r();a=[31,63,95,127][E.clip(a,9,12)-9];this._w(b[2],b[3],a)};e.prototype.getRes=function(){return[31,63,95,127].indexOf(this._r()[4])+9};e.prototype.isPresent=function(){return-1!==this.bus.search().indexOf(this.sCode)};e.prototype.getTemp=function(a){function b(f){for(var c=f._r(),g=0,d=0;8>d;d++){g^=c[d];for(var h=0;8>h;h++)g=g>>1^140*(g&1)}d=null;g==c[8]&&(d=c[0]+(c[1]<<8),d&32768&&(d-=65536),d/=10==f.type?2:16);a&&a(d);return d}this.bus.select(this.sCode);this.bus.write(68,
!0);if(!a)return b(this);setTimeout(b,{9:94,10:188,11:375,12:750}[this.getRes()],this)};e.prototype.searchAlarm=function(){return this.bus.search(236)};e.prototype.setAlarm=function(a,b){a--;0>a&&(a+=256);0>b&&(b+=256);var f=this._r();this._w(b,a,f[4])};exports.connect=function(a,b){return new e(a,b)}});
var saadc=function(a){var b={status:1073771520,enable:1073771776,amount:1073772084,tStart:1073770496,tSample:1073770500,tStop:1073770504,tCalib:1073770508,
eResultDone:1073770764,eEnd:1073770756,setDMA:function(c){c=c||{};poke32(1073772076,0|c.ptr);poke32(1073772080,0|c.cnt)},sample:function(c){c=c||1;if(1<c&&!a.samplerate)throw"Can't do >1 sample with no samplerate specified";if(1<c&&1<a.channels.length)throw"Can't do >1 channel with a samplerate specified";var f=new Uint16Array(Math.max(c*a.channels.length,32)),g=E.getAddressOf(f,!0);b.setDMA({ptr:g,cnt:c*a.channels.length});poke32(b.eEnd,0);poke32(b.tStart,1);for(poke32(b.tSample,1);!peek32(b.eEnd););
poke32(b.tStop,1);b.setDMA();return f.slice(0,c*a.channels.length)}},d=[void 0,"down","up","vcc/2"],e=[1/6,.2,.25,1/3,.5,1,2,4],k=[3,5,10,15,20,40];a.resolution||(a.resolution=14);if(!a.channels||8<a.channels.length)throw"Invalid channels";if(a.oversample&&1<a.channels.length)throw"Can't oversample with >1 channel";if(a.samplerate&&1<a.channels.length)throw"Can't use samplerate with >1 channel";poke32(b.enable,0);for(var h=0;8>h;h++)poke32(1073771792+16*h,0);a.channels.forEach(function(c,f){f=1073771792+
16*f;c.gain||(c.gain=1);c.tacq||(c.tacq=3);if(0>d.indexOf(c.pinpull))throw"Invalid pinpull";if(0>d.indexOf(c.npinpull))throw"Invalid npinpull";if(0>e.indexOf(c.gain))throw"Invalid gain";if(0>k.indexOf(c.tacq))throw"Invalid tacq";var g=d.indexOf(c.pinpull)|d.indexOf(c.npinpull)<<4|e.indexOf(c.gain)<<8|!!c.refvdd<<12|k.indexOf(c.tacq)<<16|(void 0!==c.npin)<<20|!!a.oversample<<24;poke32(f+8,g);poke32(f,0|(new Pin(c.pin)).getInfo().channel+1);poke32(f+4,0|(c.npin&&(new Pin(c.npin)).getInfo().channel)+
1)});poke32(1073772016,a.resolution-8>>1);poke32(1073772020,0|a.oversample);poke32(1073772024,a.samplerate|!!a.samplerate<<12);b.setDMA(a.dma);poke32(b.enable,1);return b};

var data;
var currentSense;

function rnd(v) { return Math.round(v*100)/100 }

function getData() {
  var va = 0, vb = 0, a = 0;
  for (var i=0;i<10;i++) {
    va += Q0.sda.analog();
    vb += Q0.scl.analog();
  }
  /*currentSense = saadc({
    channels : [ { // channel 0
      pin:Q1.sda, npin:Q1.scl,
      gain:4,
      tacq:40,
      refvdd:true,
    } ],
    oversample : 8
  });
  a = currentSense.sample()[0];
  if (a>32768) a=0;//rolled over
  poke32(currentSense.enable, 0);*/
  data = {
    t : "data",
    V1 : rnd(3.72*va),
    V : rnd(3.72*vb),
    A : rnd(a),
    throttle : rnd(H0.analog())
  };
  data.V2 = data.V-data.V1;
  data.W = rnd(data.V*data.A);
  data.temp1 = sensor1.getTemp();

  if (data.temp1==85) data.temp1="";
  data.temp2 = sensor2.getTemp();
  if (data.temp2==85) data.temp2="";
  else setFan((data.temp1 > 30)?2:0);
  Bluetooth.println(JSON.stringify(data));
  LED1.pulse(1,100);
}

function setFan(v) {
  if (v==1) {
    Q0.setPower(1);Q1.setPower(1); // fan on slow
  } else if (v==2) {
    Q0.setPower(1);Q1.setPower(0); // fan on fast
  } else {
    Q0.setPower(0);Q1.setPower(0); // fan off
  }
}

function start() {
  Q2.setPower(1);
  setInterval(getData, 1000);
}

function stop() {
  clearInterval();
  Q2.setPower(0);
}

Jolt.setDriverMode(0,false); // driver 0 off - INPUT ONLY (throttle)
pinMode(H0,"input"); // force output disable
NRF.on("disconnect",stop);

var ow = new OneWire(Q2.scl);
// ow.search() => [ "28ff33dd641401ac", "28ff8b996414038f" ]
var sensor1 = require("DS18B20x").connect(ow, "28ff33dd641401ac" );
var sensor2 = require("DS18B20x").connect(ow, "28ff8b996414038f" );
start();
\n`;
var URL = window.localStorage.getItem("SHEETS_URL")||""; // 'https://script.google.com/macros/s/.../exec';

var currentPosition;

function log(x) {
  const element = document.getElementById("log");
  var l = element.innerText.split("\n");
  l.push(x);
  if (l.length>100) l = l.slice(-100);
  element.innerText = l.join("\n");
  element.scrollTop = element.scrollHeight;
}

function sendToGoogleSheets(data) {
  var http = new XMLHttpRequest();
  var params = Object.keys(data).map(key => key+"="+data[key]).join("&");//'V1=1&V2=2&V=3&A=5.5';
  http.open('POST', URL, true);
  http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  http.onreadystatechange = function() { //Call a function when the state changes.
      if(http.readyState == 4 && http.status == 200) {
          log("[Sheets] "+http.responseText);
      }// else console.log(http);
  }
  http.send(params);
}

// Called when data received
function onLine(v) {
  v = v.trim();
  log("[Jolt.js] "+v);

  if (v.startsWith("{")) try {
    var j = JSON.parse(v);
    j.t = "data";

    if (j.W) gaugeWatts.set(j.W);

    if (currentPosition) {
      j.lat = currentPosition.latitude;
      j.lon = currentPosition.longitude;
      j.alt = currentPosition.altitude || 0;
      j.speed = (currentPosition.speed||0 ) / 3.6;
    }

    sendToGoogleSheets(j);

  } catch(e) {
    console.warn(e);
  }
}

// ======================================================= Puck.js data
var connection;
document.getElementById("connectBtn").addEventListener("click", function() {
  if (connection) {
    connection.close();
    connection = undefined;
  }
  Puck.connect(function(c) {
    if (!c) {
      alert("Couldn't connect!");
      return;
    }
    connection = c;
    // Handle the data we get back, and call 'onLine'
    // whenever we get a line
    var buf = "";
    connection.on("data", function(d) {
      buf += d;
      var i = buf.indexOf("\n");
      while (i>=0) {
        onLine(buf.substr(0,i));
        buf = buf.substr(i+1);
        i = buf.indexOf("\n");
      }
    });
    // First, reset Puck.js
    connection.write("reset();\n", function() {
      // Wait for it to reset itself
      setTimeout(function() {
        // Now tell it to write data on the current light level to Bluetooth
        // 10 times a second. Also ensure that when disconnected, Puck.js
        // resets so the setInterval doesn't keep draining battery.

        // can have 12.5 as datarate too?
        connection.write(CODE+"\n",
          function() { log("Jolt.js connected..."); });
      }, 1500);
    });
  });
});

// ======================================================= Gauges
//https://bernii.github.io/gauge.js/
var opts = {
  angle: -0.2, // The span of the gauge arc
  lineWidth: 0.2, // The line thickness
  radiusScale: 0.5, // Relative radius
  pointer: {
    length: 0.6, // // Relative to gauge radius
    strokeWidth: 0.035, // The thickness
    color: '#000000' // Fill color
  },
  limitMax: false,     // If false, max value increases automatically if value > maxValue
  limitMin: false,     // If true, the min value of the gauge will be fixed
  colorStart: '#6FADCF',   // Colors
  colorStop: '#8FC0DA',    // just experiment with them
  strokeColor: '#E0E0E0',  // to see which ones work best for you
  highDpiSupport: true,     // High resolution support
};
var gaugeWatts = new Gauge(document.getElementById('watts')).setOptions(opts);
gaugeWatts.setTextField(document.getElementById("watts-textfield"));
gaugeWatts.maxValue = 3000;
gaugeWatts.setMinValue(0);
gaugeWatts.set(0);
//gaugeWatts.animationSpeed = 32; // set animation speed (32 is default value)
var gaugeSpeed = new Gauge(document.getElementById('speed')).setOptions(opts);
gaugeSpeed.setTextField(document.getElementById("speed-textfield"));
gaugeSpeed.maxValue = 2000;
gaugeSpeed.setMinValue(0);
gaugeSpeed.set(0);

// ======================================================= GPS data

function onGPSLocation(position) {
  console.log(position);
  log("Lat " + position.coords.latitude + " Lon " + position.coords.longitude);
  gaugeSpeed.set((position.coords.speed||0) / 3.6);
  currentPosition = position.coords;
}

navigator.geolocation.watchPosition(onGPSLocation, err=>{
  log("GPS ERROR: "+err.toString());
}, {enableHighAccuracy:true});

// Test

if (!URL) log("No sheets URL - click 'Set URL' above");
document.getElementById("urlBtn").addEventListener("click", function() {
  if (!URL) URL = "https://script.google.com/macros/s/.../exec";
  URL = window.prompt("Enter URL:", URL);
  if (URL == "https://script.google.com/macros/s/.../exec") URL="";
  window.localStorage.setItem("SHEETS_URL", URL);
});

</script>
</body>
</html>
